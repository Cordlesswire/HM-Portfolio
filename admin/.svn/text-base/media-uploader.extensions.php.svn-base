<?php
function add_extra_media_buttons( $form_fields, $media ) {
		$original_post = get_post( $_GET['post_id'] );
		
		// Post thumbnails show up on all news and list items but not pages
		$main_image = "<br /><input type='submit' class='button' name='main_image[$media->ID]' value='" . attribute_escape( __( 'Use as Portfolio Entry Main Image' ) ) . "' />";
		$additional_image = "<br /><input type='submit' class='button' name='additional_images[$media->ID]' value='" . attribute_escape( __( 'Use as Portfolio Entry Additional Image' ) ) . "' />";
		
		$send = "<input type='submit' class='button' name='send[$media->ID]' value='" . attribute_escape( __( 'Insert into Post' ) ) . "' />";

		// Standard Buttons
		$delete_href = wp_nonce_url("post.php?action=delete-post&amp;post=$media->ID", 'delete-post_' . $media->ID);
		$delete = "<a href=\"#\" class=\"del-link\" onclick=\"document.getElementById('del_attachment_$media->ID').style.display='block';return false;\">" . __('Delete') . "</a>";
		
		// Create the buttons array
		$form_fields['buttons'] = array('tr' => "\t\t<tr class='submit'><td></td><td class='savesend'>$send $main_image $additional_image $partner $delete
		<div id=\"del_attachment_$media->ID\" class=\"del-attachment\" style=\"display:none;\">" . sprintf(__("You are about to delete <strong>%s</strong>."), $filename) . " <a href=\"$delete_href\" id=\"del[$media->ID]\" class=\"delete\">" . __('Continue') . "</a>
		<a href=\"#\" class=\"del-link\" onclick=\"this.parentNode.style.display='none';return false;\">" . __('Cancel') . "</a></div></td></tr>\n");
	
	// Return everything through the filter
	return $form_fields;
}
add_filter( 'attachment_fields_to_edit', 'add_extra_media_buttons', 99, 2 );

// Catch the submit for the new buttons and act accordingly
function catch_extra_media_buttons(  ) {
	?>
	
	<script type="text/javascript">

		// send html to the post editor
		function set_portfolio_main_image(id, src) {
			
		    // Close the thickbox
		    tb_remove();
		    
		    // Add the id to the hidden field
		    jQuery('#mainimagediv #jh_portfolio_main_image').attr("value",id);
		    
		  	// If there is already an image remove it
		  	if ( jQuery('#new_image img') ) { 
		  		jQuery('#new_image img').remove();
		  	}
		  		
		    // Create the image
			jQuery('<img src="'+src+'" />').appendTo('#new_image');
			
			// Finally show the containing div
			jQuery('#new_image').show('fast');
		}
		
		function set_portfolio_additional_image(id, src) {

		    // Close the thickbox
		    tb_remove();
		    
		    val = jQuery('#additionalimagesdiv input#additional_images').val();
		 	
		 	// Add the id to the hidden field
		    jQuery('#additionalimagesdiv input#additional_images').val( val + ',' + id );
		   
		    jQuery('#additionalimagesdiv .inside').append('<img rel="' + id + '" class="additional_image" src="' + src + '" />');
			
			// Finally show the containing div
			jQuery('.additional_image').show('fast');
		}
		
	</script>
	
	<?php

	// If the thumbnail button was pressed
	if ( is_array( $_POST['main_image'] ) ) :
		$attach_id = key( $_POST['main_image'] );
		$attach_url = wp_get_attachment_url( $attach_id );
		?>
		
		<script type="text/javascript">
					
			/* <![CDATA[ */
			var win = window.dialogArguments || opener || parent || top;
			win.set_portfolio_main_image( '<?php echo $attach_id; ?>', '<?php echo $attach_url; ?>' );
			/* ]]> */
		
		</script>
		
		<?php
		exit;
	endif;
	
	// If the thumbnail button was pressed
	if ( is_array( $_POST['additional_images'] ) ) :
		$attach_id = key( $_POST['additional_images'] );
		$attach_url = wp_get_attachment_url( $attach_id );
		?>
		
		<script type="text/javascript">
					
			/* <![CDATA[ */
			var win = window.dialogArguments || opener || parent || top;
			win.set_portfolio_additional_image( '<?php echo $attach_id; ?>', '<?php echo $attach_url; ?>' );
			/* ]]> */
		
		</script>
		
		<?php
		exit;
	endif;
	
}

add_filter('admin_head', 'catch_extra_media_buttons' );

// Add .flv to the list of allowed file uploads
function custom_upload_mimes( $mimes ) {
	$new_mimes['flv'] = 'video/x-flv';
	
	return $mimes + $new_mimes;
}
add_filter( 'upload_mimes', 'custom_upload_mimes' );

function save_custom_page_meta_box_info( $id ) {
	if( $_POST['jh_portfolio_main_image'] ) {
		update_post_meta( $id, 'main_image', $_POST['jh_portfolio_main_image'] );
	}
	if( $_POST['jh_portfolio_additional_images'] ) {
		update_post_meta( $id, 'additional_images', $_POST['jh_portfolio_additional_images'] );
	}
		
}
add_action( 'publish_jh_portfolio', 'save_custom_page_meta_box_info' );
?>